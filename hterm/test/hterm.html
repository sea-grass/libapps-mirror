<!DOCTYPE html>
<html>
  <head>
    <!--
    <script src='../dist/js/hterm_all.js'></script>
    -->
    <script src='/~chris/hterm_all.js'></script>
    <style>
      body {
        position: absolute;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #terminal_container {
        width: 400px;
        height: 500px;
      }
      #terminal {
        position: relative; width: 100%; height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="terminal_container">
      <div id="terminal"></div>
    </div>
    <div style="width: 600px;">
      <h3>Todo:</h3>
      <ul>
        <li>
          Properly interpret CC1 codes. By the time it gets to onVTKeystroke
          I can't tell how to interpret it. This includes the space key, backspace, control and alt,
          enter key, etc.
        </li>
        <li>
          Actually connect it to a backend
        </li>
      </ul>
    </div>
    <script>
      var t, io, key;
      //Set up hterm as per the instructions at https://github.com/jden/hterm/blob/master/embed.md
      window.addEventListener("load", function() {
        //Choose storage implementation
        hterm.defaultStorage = new lib.Storage.Memory();
        //Create an instance of hterm.Terminal
        t = new hterm.Terminal("default");

        //Write a onTerminalReady handler that will fire once, when the terminal is init'd and ready for use
        t.onTerminalReady = function() {
          //Create new terminal IO object and give it the foreground
          io = t.io.push();

          //Need to call installKeyboard so it can accept user input
          t.installKeyboard();

          io.onVTKeystroke = function(str) {
            //Do something useful with str here
            //For example, Secure Shell forwards the string onto the NaCL plugin


            function isEnterKey(str) {
              //So, I don't know how to detect the enter key
              //So I've come up with a hack
              //If it the enter key, then:
              //  ((str + "".length).length).trim().length === 1
              //If not, then
              //  ((str + "".length).length).trim().length === 2

              //This hack also thinks space and any other special character
              //are the enter key. The if statement below checks for
              //the space key, but all other CC1 codes are interpreted as the
              //enter key. Need to research a better way to determine this
              if (str === " ") {
                return false;
              }
              var test = (str + "".length).trim().length;
              if (test === 1) {
                return true;
              } else if (test === 2) {
                return false;
              }
            }
            key = str;
            if (isEnterKey(str)) {
              //insertLines inserts lines above
              //t.insertLines(1);
              t.io.println("");
            } else {
              console.log("not enter key");
              t.io.print(str);
            }
          };
          io.sendString = function(str) {
            //Just like a keystroke, except str was generated by the terminal itself
            //Most likely you'll do the same as onVTKeystroke
            //console.log("sendString", str);
            console.log(str);
          };
          io.onTerminalResize = function(columns, rows) {
            //React to size changes here
            //Secure Shell pokes at NaCl, which eventually results in
            //som ioctls on the host
            console.log("onTerminalResize", columns, rows);
          };

          //You can call io.push() to foreground a fresh io context, which can
          //be used to give control of the terminal to something else. When that
          //thing is complete, should call io.pop() to restore control to the
          //previous io object
        };

        //Now connect the terminal to the DOM node
        t.decorate(document.querySelector("#terminal"));
        console.log("Terminal ready and added");
        t.io.println("Welcome to hterm!");
      });
    </script>
  </body>
</html>
